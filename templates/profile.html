{% extends "base.html" %}

{% block title %}个人中心 - 电影推荐系统{% endblock %}

{% block content %}
<div class="row">
    <!-- 侧边栏 -->
    <div class="col-md-3">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-user me-2"></i>个人中心</h5>
            </div>
            <div class="list-group list-group-flush">
                <a href="#profile" class="list-group-item list-group-item-action active" data-bs-toggle="pill">
                    <i class="fas fa-user-edit me-2"></i>个人信息
                </a>
                <a href="#ratings" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                    <i class="fas fa-star me-2"></i>我的评分
                </a>
                <a href="#reviews" class="list-group-item list-group-item-action" data-bs-toggle="pill">
                    <i class="fas fa-comment me-2"></i>我的评论
                </a>
            </div>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="col-md-9">
        <div class="tab-content">
            <!-- 个人信息标签页 -->
            <div class="tab-pane fade show active" id="profile">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>个人信息</h5>
                    </div>
                    <div class="card-body">
                        {% if profile_updated %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            个人信息更新成功！
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}

                        <form method="POST" action="{{ url_for('update_profile') }}">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="username" class="form-label">用户名</label>
                                        <input type="text" class="form-control" id="username" name="username" 
                                               value="{{ user_info.username }}" readonly>
                                        <div class="form-text">用户名不能修改</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">邮箱</label>
                                        <input type="email" class="form-control" id="email" name="email" 
                                               value="{{ user_info.email or '' }}" placeholder="请输入邮箱">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="new_password" class="form-label">新密码</label>
                                        <input type="password" class="form-control" id="new_password" name="new_password" 
                                               placeholder="如不修改密码请留空">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="confirm_password" class="form-label">确认新密码</label>
                                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" 
                                               placeholder="请再次输入新密码">
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between">
                                <div>
                                    <small class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        注册时间：{{ user_info.created_at }}
                                    </small>
                                </div>
                                <div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-1"></i>保存修改
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 我的评分标签页 -->
            <div class="tab-pane fade" id="ratings">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-star me-2"></i>我的评分</h5>
                    </div>
                    <div class="card-body">
                        {% if ratings %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>电影</th>
                                            <th>评分</th>
                                            <th>评分时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for rating in ratings %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <img src="{{ rating.image_url or 'https://picsum.photos/seed/default/50/75.jpg' }}" 
                                                         alt="{{ rating.title }}" class="me-3" style="width: 50px; height: 75px; object-fit: cover;">
                                                    <div>
                                                        <strong>{{ rating.title }}</strong>
                                                        <br>
                                                        <small class="text-muted">{{ rating.year }} · {{ rating.director }}</small>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="rating-stars">
                                                    {% for i in range(5) %}
                                                        {% if i < rating.rating %}
                                                            <i class="fas fa-star"></i>
                                                        {% else %}
                                                            <i class="far fa-star"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                    <span class="ms-1">{{ rating.rating }}/5</span>
                                                </div>
                                            </td>
                                            <td>{{ rating.created_at }}</td>
                                            <td>
                                                <a href="{{ url_for('movie_detail', movie_id=rating.movie_id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye me-1"></i>查看
                                                </a>
                                                <a href="{{ url_for('delete_rating', rating_id=rating.id) }}" 
                                                   class="btn btn-sm btn-outline-danger"
                                                   onclick="return confirm('确定要删除这条评分记录吗？')">
                                                    <i class="fas fa-trash me-1"></i>删除
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="mt-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h4 class="text-primary">{{ ratings|length }}</h4>
                                                <p class="mb-0">已评分电影</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h4 class="text-warning">{{ "%.1f"|format(avg_rating) }}</h4>
                                                <p class="mb-0">平均评分</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body text-center">
                                                <h4 class="text-info">{{ highest_rated_movie.title or '暂无' }}</h4>
                                                <p class="mb-0">最高评分电影</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-star fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">您还没有评分任何电影</h5>
                                <p class="text-muted">快去浏览电影并给出您的评价吧！</p>
                                <a href="{{ url_for('index') }}" class="btn btn-primary">
                                    <i class="fas fa-film me-1"></i>浏览电影
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 我的评论标签页 -->
            <div class="tab-pane fade" id="reviews">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-comment me-2"></i>我的评论</h5>
                    </div>
                    <div class="card-body">
                        {% if reviews %}
                            {% for review in reviews %}
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <h6 class="card-title mb-1">
                                                <a href="{{ url_for('movie_detail', movie_id=review.movie_id) }}" 
                                                   class="text-decoration-none">
                                                    {{ review.title }}
                                                </a>
                                            </h6>
                                            <div class="rating-stars small">
                                                {% for i in range(5) %}
                                                    {% if i < review.rating %}
                                                        <i class="fas fa-star"></i>
                                                    {% else %}
                                                        <i class="far fa-star"></i>
                                                    {% endif %}
                                                {% endfor %}
                                                <span class="ms-1">{{ review.rating }}/5</span>
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ review.created_at }}</small>
                                    </div>
                                    
                                    {% if review.review %}
                                    <p class="card-text">{{ review.review }}</p>
                                    {% else %}
                                    <p class="card-text text-muted fst-italic">该用户只评分未评论</p>
                                    {% endif %}
                                    
                                    <div class="mt-2">
                                        <a href="{{ url_for('movie_detail', movie_id=review.movie_id) }}" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-reply me-1"></i>查看详情
                                        </a>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">您还没有发表任何评论</h5>
                                <p class="text-muted">去电影详情页分享您的观影感受吧！</p>
                                <a href="{{ url_for('index') }}" class="btn btn-primary">
                                    <i class="fas fa-film me-1"></i>浏览电影
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// 密码确认验证
document.querySelector('form').addEventListener('submit', function(e) {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (newPassword && newPassword !== confirmPassword) {
        e.preventDefault();
        alert('新密码和确认密码不匹配，请重新输入！');
    }
    
    if (newPassword && newPassword.length < 6) {
        e.preventDefault();
        alert('新密码长度至少6位！');
    }
});
</script>
{% endblock %}